import{cX as k,cY as V,cZ as U,c_ as x,c$ as D,d0 as J,d1 as H,d2 as Y,b as M,r as b,bP as z,a4 as B,Q as K,j as T,x as X,d3 as F,d4 as L,d5 as G,bX as W,d6 as Z,d7 as ee,d8 as te}from"./sanity-DyhyTRlS.js";import{c as re,a as se}from"./PresentationToolGrantsCheck-Cqp8xE5b.js";import{i as $}from"./DisplayedDocumentBroadcaster-CaxBbJvr.js";const ne=/^[a-z0-9_]+$/i;function ie(t){if(Array.isArray(t)&&t.includes("raw"))throw new TypeError('Invalid API perspective value: "raw". The raw-perspective can not be combined with other perspectives');const e=(Array.isArray(t)?t:[t]).filter(s=>typeof s!="string"||!ne.test(s));if(e.length>0){const s=e.map(a=>JSON.stringify(a));throw new TypeError(`Invalid API perspective value${e.length===1?"":"s"}: ${s.join(", ")}, expected \`published\`, \`drafts\`, \`raw\` or a release identifier string`)}}function ae(t){if(ie(t),Array.isArray(t))return t.includes("published")?t:[...t,"published"];switch(t){case"previewDrafts":case"drafts":return["drafts","published"];case"published":default:return["published"]}}function oe(t,e){const s=ae(e);function a(r){for(const n of s){let i=null;if(n.startsWith("r")&&(i=t({...r,_id:V(r._id,n)})),n==="drafts"&&(i=t({...r,_id:U(r._id)})),n==="published"&&(i=t({...r,_id:x(r._id)})),i)return{...i,_id:x(i._id),_originalId:i._id}}return null}return function(r){return a(r)}}function ue(t,e,s,a,r){var h,f;if(!e)return t;const n=oe(s,r),i=((f=(h=e.documents)==null?void 0:h.map)==null?void 0:f.call(h,n))||[];return k(JSON.parse(JSON.stringify(t)),(c,l)=>{const p=D(l,e);if(!p)return c;const{mapping:o,pathSuffix:S}=p;if(o.type!=="value"||o.source.type!=="documentValue")return c;const m=e.documents[o.source.document],I=e.paths[o.source.path];if(m){const g=J(I+S),v=H(g),w=i[o.source.document];if(!w)return c;const _=w?Y(w,v,c):c;return c===_?c:a(_,{cachedDocument:w,previousValue:c,sourceDocument:m,sourcePath:g})}return c})}function ce(t,e){switch(e.type){case"message":return{...t,messages:[...t.messages,e]};case"reconnect":case"restart":return{...t,messages:[],resets:t.resets+1};case"welcome":return t;default:throw Error(`Unknown event: ${e.type}`,{cause:e})}}const le={messages:[],resets:0};function pe(t){const e=M.c(3),[s,a]=b.useReducer(ce,le),[r,n]=b.useState(null);if(r!==null)throw r;let i,h;return e[0]!==t.live?(i=()=>{const f=t.live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:a,error:c=>n(c instanceof Error?c:new Error("Unexpected error in useLiveEvents",{cause:c}))});return()=>f.unsubscribe()},h=[t.live],e[0]=t.live,e[1]=i,e[2]=h):(i=e[1],h=e[2]),b.useEffect(i,h),b.useDeferredValue(s)}const fe=(t,{previousValue:e})=>{if(typeof e=="string"){if(typeof t=="number")return`${t}`;if(Array.isArray(t)){if(t.length===0)return"";if(t.some(s=>typeof s=="object"&&ee(s)))return te(t)}}return t};function de(t,e,s){return`${t}:${e}:${JSON.stringify(s)}`}function he(t){if(t.queries.size<1)return t;const e=Date.now();if(!Array.from(t.heartbeats.values()).some(r=>r.heartbeat!==!1&&e>r.receivedAt+r.heartbeat))return t;const s=new Map,a=new Map;for(const[r,n]of t.heartbeats.entries())n.heartbeat!==!1&&e>n.receivedAt+n.heartbeat||(s.set(r,n),a.set(r,t.queries.get(r)));return{...t,queries:a,heartbeats:s}}function ye(t,{payload:e}){const s=de(e.perspective,e.query,e.params),a={query:e.query,params:e.params,perspective:e.perspective},r=new Map(t.heartbeats);r.set(s,{receivedAt:Date.now(),heartbeat:e.heartbeat});let n=t.queries;return(!t.queries.has(s)||!$(t.queries.get(s),a))&&(n=new Map(t.queries),n.set(s,a)),{heartbeats:r,queries:n}}function be(t,e){switch(e.type){case"query-listen":return ye(t,e);case"gc":return he(t);default:throw Error(`Unknown action: ${e.type}`,{cause:e})}}const me={queries:new Map,heartbeats:new Map};function ge(){const t=M.c(4),[e,s]=b.useReducer(be,me);let a,r;t[0]===Symbol.for("react.memo_cache_sentinel")?(a=()=>{const h=setInterval(()=>s({type:"gc"}),F);return()=>clearInterval(h)},r=[],t[0]=a,t[1]=r):(a=t[0],r=t[1]),b.useEffect(a,r);const n=b.useDeferredValue(e.queries);let i;return t[2]!==n?(i=[n,s],t[2]=n,t[3]=i):i=t[3],i}function Pe(t){const e=M.c(31),{controller:s,perspective:a,onLoadersConnection:r,onDocumentsOnPage:n}=t,[i,h]=b.useState(),[f,c]=ge(),l=z(),p=B();let o,S;e[0]!==s||e[1]!==p||e[2]!==c||e[3]!==n||e[4]!==r||e[5]!==l?(o=()=>{if(s){const P=s.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},re().provide({actors:se()}));return h(P),P.onStatus(r),P.on("loader/documents",E=>{E.projectId===l&&E.dataset===p&&n("loaders",E.perspective,E.documents)}),P.on("loader/query-listen",E=>{if(E.projectId===l&&E.dataset===p){if(typeof E.heartbeat=="number"&&E.heartbeat<L)throw new Error(`Loader query listen heartbeat interval must be at least ${L}ms`);c({type:"query-listen",payload:{perspective:E.perspective,query:E.query,params:E.params,heartbeat:E.heartbeat??!1}})}}),P.start()}return Ee},S=[s,p,c,n,r,l],e[0]=s,e[1]=p,e[2]=c,e[3]=n,e[4]=r,e[5]=l,e[6]=o,e[7]=S):(o=e[6],S=e[7]),b.useEffect(o,S);let m;e[8]!==a?(m=Z(a)?G:{apiVersion:W},e[8]=a,e[9]=m):m=e[9];const I=K(m);let g,v;e[10]!==I?(v=I.withConfig({resultSourceMap:"withKeyArraySelector"}),e[10]=I,e[11]=v):v=e[11],g=v;const w=g;let _,q;e[12]!==a||e[13]!==i||e[14]!==p||e[15]!==l?(_=()=>{i&&i.post("loader/perspective",{projectId:l,dataset:p,perspective:a})},q=[i,a,l,p],e[12]=a,e[13]=i,e[14]=p,e[15]=l,e[16]=_,e[17]=q):(_=e[16],q=e[17]),b.useEffect(_,q);const R=b.useDeferredValue(t.liveDocument),A=pe(w);let y;e[18]!==f?(y=f.entries(),e[18]=f,e[19]=y):y=e[19];let u;e[20]!==y?(u=[...y],e[20]=y,e[21]=u):u=e[21];let d;return e[22]!==w||e[23]!==i||e[24]!==p||e[25]!==R||e[26]!==A.messages||e[27]!==A.resets||e[28]!==l||e[29]!==u?(d=T.jsx(T.Fragment,{children:u.map(P=>{const[E,Q]=P,{query:j,params:N,perspective:O}=Q;return T.jsx(C,{projectId:l,dataset:p,perspective:O,query:j,params:N,comlink:i,client:w,liveDocument:R,liveEventsMessages:A.messages},`${A.resets}:${E}`)})}),e[22]=w,e[23]=i,e[24]=p,e[25]=R,e[26]=A.messages,e[27]=A.resets,e[28]=l,e[29]=u,e[30]=d):d=e[30],d}function Ee(){}function ve(t){const e=M.c(20),{projectId:s,dataset:a,perspective:r,query:n,client:i,liveDocument:h,params:f,comlink:c,liveEventsMessages:l}=t,{result:p,resultSourceMap:o,syncTags:S}=we({client:i,liveDocument:h,params:f,perspective:r,query:n,liveEventsMessages:l})||{};let m;e[0]!==a||e[1]!==s?(m=(w,_,q,R,A,y,u)=>{w==null||w.post("loader/query-change",{projectId:s,dataset:a,perspective:_,query:q,params:R,result:A,resultSourceMap:y,tags:u})},e[0]=a,e[1]=s,e[2]=m):m=e[2];const I=X(m);let g;e[3]!==c||e[4]!==I||e[5]!==f||e[6]!==r||e[7]!==n||e[8]!==p||e[9]!==o||e[10]!==S?(g=()=>{o&&I(c,r,n,f,p,o,S)},e[3]=c,e[4]=I,e[5]=f,e[6]=r,e[7]=n,e[8]=p,e[9]=o,e[10]=S,e[11]=g):g=e[11];let v;return e[12]!==c||e[13]!==f||e[14]!==r||e[15]!==n||e[16]!==p||e[17]!==o||e[18]!==S?(v=[c,f,r,n,p,o,S],e[12]=c,e[13]=f,e[14]=r,e[15]=n,e[16]=p,e[17]=o,e[18]=S,e[19]=v):v=e[19],b.useEffect(g,v),null}const C=b.memo(ve);C.displayName="Memo(QuerySubscription)";function we(t){const e=M.c(30),{liveDocument:s,client:a,query:r,params:n,perspective:i,liveEventsMessages:h}=t,[f,c]=b.useState(null),[l,p]=b.useState(null),[o,S]=b.useState(void 0);let m;e[0]!==h?(m=()=>new Set(h.map(Se)),e[0]=h,e[1]=m):m=e[1];const[I]=b.useState(m);let g;if(e[2]!==h||e[3]!==I||e[4]!==o){let y;e[6]!==I?(y=P=>!I.has(P.id),e[6]=I,e[7]=y):y=e[7];const u=h.filter(y);let d;e[8]!==o?(d=P=>P.tags.some(E=>o==null?void 0:o.includes(E)),e[8]=o,e[9]=d):d=e[9],g=u.findLast(d),e[2]=h,e[3]=I,e[4]=o,e[5]=g}else g=e[5];const v=g==null?void 0:g.id,[w,_]=b.useState(null);if(w)throw w;let q,R;e[10]!==a||e[11]!==v||e[12]!==n||e[13]!==i||e[14]!==r?(q=()=>{const y=new AbortController;return a.fetch(r,n,{lastLiveEventId:v,tag:"presentation-loader",signal:y.signal,perspective:i,filterResponse:!1,returnQuery:!1}).then(u=>{b.startTransition(()=>{c(d=>$(d,u.result)?d:u.result),p(d=>$(d,u.resultSourceMap)?d:u.resultSourceMap),S(d=>$(d,u.syncTags)?d:u.syncTags)})}).catch(u=>{(typeof u!="object"||(u==null?void 0:u.name)!=="AbortError")&&_(u)}),()=>{y.abort()}},R=[a,v,n,i,r],e[10]=a,e[11]=v,e[12]=n,e[13]=i,e[14]=r,e[15]=q,e[16]=R):(q=e[15],R=e[16]),b.useEffect(q,R);let A;e:{if(s&&l){let u;e[17]!==s||e[18]!==i||e[19]!==f||e[20]!==l?(u=Ie(s,f,i,l),e[17]=s,e[18]=i,e[19]=f,e[20]=l,e[21]=u):u=e[21];let d;e[22]!==l||e[23]!==o||e[24]!==u?(d={result:u,resultSourceMap:l,syncTags:o},e[22]=l,e[23]=o,e[24]=u,e[25]=d):d=e[25],A=d;break e}let y;e[26]!==f||e[27]!==l||e[28]!==o?(y={result:f,resultSourceMap:l,syncTags:o},e[26]=f,e[27]=l,e[28]=o,e[29]=y):y=e[29],A=y}return A}function Se(t){return t.id}function Ie(t,e,s,a){if(s==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return ue(e,a,r=>!r._projectId&&(t!=null&&t._id)&&x(t._id)===x(r._id)?typeof t._id=="string"&&typeof r._type=="string"?t:{...t,_id:t._id||r._id,_type:t._type||r._type}:null,fe,s)}export{Pe as default,Ie as turboChargeResultIfSourceMap};
